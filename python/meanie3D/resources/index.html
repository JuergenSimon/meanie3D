<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Page Template</title>
		<!--<script src="d3.js" charset="utf-8"></script>-->
		<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>-->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.js" charset="utf-8"></script>
		<script src="meanie3d.js" charset="utf-8"/></script>
		<style>
			.container {
			    overflow:scroll;
			}
			svg {
			    width: 100%;
			    height: 100%;
			}
		</style>
    </head>
    <body>
		<div class="container" id="svg-container"></div>
		<script type="text/javascript">

			var radius = 12;
			var fontSize = 9;

			var filterById = M3D.getUrlParameter('id');
			var filterIds = new Set();

			var color = d3.scale.category20();
			
			var viewport = {
				width: Math.max(document.documentElement.clientWidth, window.innerWidth || 0),
				height: Math.max(document.documentElement.clientHeight, window.innerHeight || 0)
			}
			
			var width = filterById ? viewport.width / 2 : viewport.width;  
			var height = filterById ? viewport.height / 2 : viewport.height;  

			var force = d3.layout.force()
				.charge(-150)
				.linkDistance(50)
				.size([width, height]);

			var svg = d3.select("body").select("div#svg-container").append("svg");
			M3D.resizeSvg();

			d3.json("track-dictionary.json", function(error, dictionary) {
				if (error) throw error;

				var graph = new M3D.TrackingGraph(dictionary,filterById);

				force
					.nodes(graph.nodes)
					.links(graph.links)
					.start();
				
				var link = svg.selectAll(".link")
					.data(graph.links)
					.enter().append("line")
					.filter(function(d) {
						return graph.linkFilter(d);
					})
					.attr("class", "link")
					.style("stroke", function(d) { 
						if (d.type == 0) {
							return "lightgrey"
						} else if (d.type == 1) {
							return "red";
						} else {
							return "blue";
						}
					})
					.style("stroke-width", function(d) { 
						return 2; 
					});
			
				var node = svg.selectAll(".node")
					.data(graph.nodes)
					.enter().append("circle")
					.filter(function(d) {
						return graph.nodeFilter(d);
					})
					.attr("class", "node")
					.attr("r", function(d) { 
						return 2.0 * Math.log(1.0 + d.size);
					})
					.style("fill", function(d) { return color(d.id); })
					.on("dblclick", function(d) {
						M3D.navigateTo(d);
					})
					.call(force.drag);
			
				var label = svg.selectAll("text")
					.data(graph.nodes)
					.enter().append("text")
					.filter(function(d) {
						return graph.nodeFilter(d);
					})
					.text(function(d) {
						return d.id;
						// return d.uuid + "/" + d.id;
					})
					.attr("fill","black")
					.attr("text-anchor", "middle")
					.attr("text-align", "center")
					.attr("alignment-baseline","central")
					.attr("font-family", "sans-serif")
					.attr("font-size", function() {
						return fontSize + "px";
					})
					.attr("font-weight", "bold");

				node.append("title")
					.filter(function(d) {
						return graph.nodeFilter(d);
					})
					.text(function(d) {
						return d.name;
					});

				force.on("tick", function() {
					link
						.attr("x1", function(d) { return d.source.x; })
						.attr("y1", function(d) { return d.source.y; })
						.attr("x2", function(d) { return d.target.x; })
						.attr("y2", function(d) { return d.target.y; })
						.attr("opacity", function(d) {
							return 0.25 + 0.75 * (d.source.step / graph.steps.length);
						});
					

					node
						.attr("cx", function(d) { return d.x; })
						.attr("cy", function(d) { return d.y; })
						.attr("opacity", function(d) {
							return 0.25 + 0.75 * (d.step / graph.steps.length);
						});

					label
						.attr("x", function(d, i) {
							return d.x;
						})
						.attr("y", function(d, i) {
							return d.y;
						});
				});
			});

		</script>
	</body>
</html>l