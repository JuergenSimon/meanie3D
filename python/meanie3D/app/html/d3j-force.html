<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Page Template</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.js" charset="utf-8"></script>
		<style>
			.container {
			    overflow:scroll;
			}
			svg {
			    width: 150%;
			    height: 150%;
			}
		</style>
    </head>
    <body>
		<div class="container" id="svg-container"></div>
		<script type="text/javascript">

			var width = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
			var height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0)

			var radius = 12;
			var fontSize = 9;

			var filterById = getQueryVariable('id');

			var color = d3.scale.category20();

			var force = d3.layout.force()
				.charge(-100)
				.linkDistance(50)
				.size([width, height]);

			var svg = d3.select("body").select("div#svg-container").append("svg");
			resizeSvg();

			d3.json("track-dictionary.json", function(error, dictionary) {
				if (error) throw error;

				var nodes = dictionary.tree.nodes;
				var links = dictionary.tree.links;
				var filteredLinks = links;

				if (filterById) {
					function matchesId(element,index,array) {
						return element.id == filterById;
					}
					filteredLinks = links.filter(matchesId);
				}
			
				// Filter nodes only to what is needed by links
				function isLinked(node) {
					for (var i=0; i < filteredLinks.length; i++) {
						var link = filteredLinks[i];
						if (link.source.uuid == node.uuid || link.target.uuid == node.uuid) {
							return true;
						}
					}
					return false;
				}
			
				var steps = new Array();
				var ids = new Array();
				nodes.forEach(function(node) {
					if (steps.indexOf(node.step) < 0) 
						steps.push(node.step);
					if (ids.indexOf(node.id) < 0) 
						ids.push(node.id);
				});
		
				ids.sort(function(a,b) {
					return parseInt(a.id) < parseInt(b.id);
				});
				steps.sort(function(a,b) {
					return parseInt(a.step) < parseInt(b.step);
				});

				force.nodes(nodes)
					.links(links)
					.start();
				
				var link = svg.selectAll(".link")
					.data(links)
					.enter().append("line")
					.filter(function(d) {
						return filterById ? (d.id == filterById) : true;
					})
					.attr("class", "link")
					.style("stroke", function(d) { 
						if (d.type == 0) {
							return "lightgrey"
						} else if (d.type == 1) {
							return "red";
						} else {
							return "blue";
						}
					})
					.style("stroke-width", function(d) { 
						return 2; 
					});
			
				var node = svg.selectAll(".node")
					.data(nodes)
					.enter().append("circle")
					.filter(function(d) {
						return isLinked(d);
					})
					.attr("class", "node")
					.attr("r", function(d) { 
						return 2.0 * Math.log(1.0 + d.size);
					})
					.style("fill", function(d) { return color(d.id); })
					.call(force.drag);
			
				var label = svg.selectAll("text")
					.data(nodes)
					.enter().append("text")
					.filter(function(d) {
						return isLinked(d);
					})
					.text(function(d) {
						return d.id;
						// return d.uuid + "/" + d.id;
					})
					.attr("fill","black")
					.attr("text-anchor", "middle")
					.attr("text-align", "center")
					.attr("alignment-baseline","central")
					.attr("font-family", "sans-serif")
					.attr("font-size", function() {
						return fontSize + "px";
					})
					.attr("font-weight", "bold");

				node.append("title")
					.filter(function(d) {
						return isLinked(d);
					})
					.text(function(d) { return d.name; });

				force.on("tick", function() {
					link
						.attr("x1", function(d) { return d.source.x; })
						.attr("y1", function(d) { return d.source.y; })
						.attr("x2", function(d) { return d.target.x; })
						.attr("y2", function(d) { return d.target.y; })
						.attr("opacity", function(d) {
							return 0.25 + 0.75 * (d.source.step / steps.length);
						});
					

					node
						.attr("cx", function(d) { return d.x; })
						.attr("cy", function(d) { return d.y; })
						.attr("opacity", function(d) {
							return 0.25 + 0.75 * (d.step / steps.length);
						});

					label
						.attr("x", function(d, i) {
							return d.x;
						})
						.attr("y", function(d, i) {
							return d.y;
						});
				});
			});
		
			/**
			 * Courtesy of https://css-tricks.com/snippets/javascript/get-url-variables/
			 */
			function getQueryVariable(variable)
			{
			       var query = window.location.search.substring(1);
			       var vars = query.split("&");
			       for (var i=0;i<vars.length;i++) {
			               var pair = vars[i].split("=");
			               if(pair[0] == variable){return pair[1];}
			       }
			       return(false);
			}
		
			function resizeSvg() {
				var width = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
				var height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0)
				d3.select("svg")
					.attr("width", width)
					.attr("height", height);
			}

		</script>
	</body>
</html>